-- =========================
-- DROP TABLES (ignore errors if not exists)
-- =========================
BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE SERVES CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE PASSENGER_PHONE_NO CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE TICKET CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE PASSENGER CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE EMP_PHONE_NO CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE EMPLOYEE CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE FLIGHT CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE CONTAINS CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE AIRLINE CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE AIRPORT CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE AAIRPORT CASCADE CONSTRAINTS';
EXCEPTION WHEN OTHERS THEN NULL;
END;
/

-- =========================
-- CREATE TABLES
-- =========================

CREATE TABLE AIRPORT (
    AIRPORT_NAME VARCHAR2(50) PRIMARY KEY,
    CITY VARCHAR2(50),
    STATE VARCHAR2(50)
);

CREATE TABLE AIRLINE (
    AIRLINE_ID NUMBER PRIMARY KEY,
    AIRLINE_NAME VARCHAR2(50),
    AIRPORT_NAME VARCHAR2(50),
    FOREIGN KEY (AIRPORT_NAME) REFERENCES AIRPORT(AIRPORT_NAME)
);

CREATE TABLE CONTAINS (
    AIRPORT_NAME VARCHAR2(50),
    AIRLINE_ID NUMBER,
    FOREIGN KEY (AIRPORT_NAME) REFERENCES AIRPORT(AIRPORT_NAME),
    FOREIGN KEY (AIRLINE_ID) REFERENCES AIRLINE(AIRLINE_ID)
);

CREATE TABLE FLIGHT (
    FLIGHT_NO NUMBER PRIMARY KEY,
    SOURCE VARCHAR2(50) NOT NULL,
    DESTINATION VARCHAR2(50) NOT NULL,
    D_TIME DATE,
    A_TIME DATE,
    DURATION NUMBER NOT NULL,
    AIRLINE_ID NUMBER,
    FOREIGN KEY (AIRLINE_ID) REFERENCES AIRLINE(AIRLINE_ID)
);

CREATE TABLE EMPLOYEE (
    E_ID NUMBER PRIMARY KEY,
    NAME VARCHAR2(50),
    ADDRESS VARCHAR2(50),
    SEX VARCHAR2(10),
    SALARY NUMBER,
    AGE NUMBER,
    AIRPORT_NAME VARCHAR2(50),
    FOREIGN KEY (AIRPORT_NAME) REFERENCES AIRPORT(AIRPORT_NAME)
);

CREATE TABLE EMP_PHONE_NO (
    E_ID NUMBER,
    PHONE_NO VARCHAR2(15),
    FOREIGN KEY (E_ID) REFERENCES EMPLOYEE(E_ID)
);

CREATE TABLE PASSENGER (
    PASSPORT_NO VARCHAR2(20) PRIMARY KEY,
    NAME VARCHAR2(50) NOT NULL,
    ADDRESS VARCHAR2(50),
    SEX VARCHAR2(10),
    DOB DATE,
    AGE NUMBER,
    FLIGHT_NO NUMBER,
    TICKET_NO VARCHAR2(20),
    FOREIGN KEY (FLIGHT_NO) REFERENCES FLIGHT(FLIGHT_NO)
);

CREATE TABLE SERVES (
    E_ID NUMBER,
    PASSPORT_NO VARCHAR2(20),
    FOREIGN KEY (E_ID) REFERENCES EMPLOYEE(E_ID),
    FOREIGN KEY (PASSPORT_NO) REFERENCES PASSENGER(PASSPORT_NO)
);

CREATE TABLE PASSENGER_PHONE_NO (
    PASSPORT_NO VARCHAR2(20),
    PHONE_NO VARCHAR2(15),
    FOREIGN KEY (PASSPORT_NO) REFERENCES PASSENGER(PASSPORT_NO)
);

CREATE TABLE TICKET (
    TICKET_NO VARCHAR2(20) PRIMARY KEY,
    AIRLINE_NAME VARCHAR2(50) NOT NULL,
    PRICE NUMBER NOT NULL,
    SEAT_NO VARCHAR2(20),
    CLASS VARCHAR2(10),
    D_TIME DATE,
    A_TIME DATE,
    DURATION NUMBER,
    DESTINATION VARCHAR2(50),
    SOURCE VARCHAR2(50),
    PASSPORT_NO VARCHAR2(20),
    PASSENGER_NAME VARCHAR2(50),
    FOREIGN KEY (PASSPORT_NO) REFERENCES PASSENGER(PASSPORT_NO)
);

-- =========================
-- INSERT DATA
-- =========================

INSERT INTO AIRPORT (AIRPORT_NAME, CITY, STATE) VALUES ('Shivaji', 'Mumbai', 'Maharashtra');
INSERT INTO AIRPORT (AIRPORT_NAME, CITY, STATE) VALUES ('Indra Gandhi Int', 'Delhi', 'Maharashtra');

INSERT INTO EMPLOYEE (E_ID, NAME, ADDRESS, SEX, SALARY, AGE, AIRPORT_NAME) VALUES (13, 'parth', 'mumbai', 'M', 40000, 19, 'Shivaji');
INSERT INTO EMPLOYEE (E_ID, NAME, ADDRESS, SEX, SALARY, AGE, AIRPORT_NAME) VALUES (14, 'ramesh', 'mumbai', 'M', 30000, 20, 'Shivaji');
INSERT INTO EMPLOYEE (E_ID, NAME, ADDRESS, SEX, SALARY, AGE, AIRPORT_NAME) VALUES (15, 'ram', 'delhi', 'M', 20000, 23, 'Indra Gandhi Int');
INSERT INTO EMPLOYEE (E_ID, NAME, ADDRESS, SEX, SALARY, AGE, AIRPORT_NAME) VALUES (16, 'rani', 'delhi', 'F', 22000, 19, 'Indra Gandhi Int');

INSERT INTO EMP_PHONE_NO (E_ID, PHONE_NO) VALUES (13, '1111111111');
INSERT INTO EMP_PHONE_NO (E_ID, PHONE_NO) VALUES (14, '3333333333');
INSERT INTO EMP_PHONE_NO (E_ID, PHONE_NO) VALUES (16, '6666666666');

INSERT INTO AIRLINE (AIRLINE_ID, AIRLINE_NAME, AIRPORT_NAME) VALUES (123, 'MLines', 'Shivaji');
INSERT INTO AIRLINE (AIRLINE_ID, AIRLINE_NAME, AIRPORT_NAME) VALUES (124, 'Dlines', 'Indra Gandhi Int');

INSERT INTO FLIGHT (FLIGHT_NO, SOURCE, DESTINATION, D_TIME, A_TIME, DURATION, AIRLINE_ID) VALUES
(12345, 'Mumbai', 'Delhi', TO_DATE('20-FEB-2022 04:00 AM','DD-MON-YYYY HH:MI AM'), TO_DATE('20-FEB-2022 08:30 AM','DD-MON-YYYY HH:MI AM'), 360, 123);
INSERT INTO FLIGHT (FLIGHT_NO, SOURCE, DESTINATION, D_TIME, A_TIME, DURATION, AIRLINE_ID) VALUES
(12356, 'Delhi', 'Mumbai', TO_DATE('20-FEB-2022 10:00 PM','DD-MON-YYYY HH:MI AM'), TO_DATE('21-FEB-2022 04:00 AM','DD-MON-YYYY HH:MI AM'), 180, 123);
INSERT INTO FLIGHT (FLIGHT_NO, SOURCE, DESTINATION, D_TIME, A_TIME, DURATION, AIRLINE_ID) VALUES
(12389, 'Delhi', 'Mumbai', TO_DATE('24-FEB-2022 09:15 AM','DD-MON-YYYY HH:MI AM'), TO_DATE('25-FEB-2022 09:30 AM','DD-MON-YYYY HH:MI AM'), 150, 123);

INSERT INTO PASSENGER (PASSPORT_NO, NAME, ADDRESS, SEX, DOB, AGE, FLIGHT_NO, TICKET_NO) VALUES ('123', 'Parth', 'A22', 'Male', TO_DATE('28-03-2002','DD-MM-YYYY'), 5, 12356, '786');
INSERT INTO PASSENGER (PASSPORT_NO, NAME, ADDRESS, SEX, DOB, AGE, FLIGHT_NO, TICKET_NO) VALUES ('456', 'Tushar', 'B22', 'Male', TO_DATE('12-08-2001','DD-MM-YYYY'), 19, 12345, '777');
INSERT INTO PASSENGER (PASSPORT_NO, NAME, ADDRESS, SEX, DOB, AGE, FLIGHT_NO, TICKET_NO) VALUES ('789', 'Raj', 'D45', 'Male', TO_DATE('13-06-1972','DD-MM-YYYY'), 64, 12345, '786');

INSERT INTO PASSENGER_PHONE_NO (PASSPORT_NO, PHONE_NO) VALUES ('123', '1111');
INSERT INTO PASSENGER_PHONE_NO (PASSPORT_NO, PHONE_NO) VALUES ('456', '3333333333');
INSERT INTO PASSENGER_PHONE_NO (PASSPORT_NO, PHONE_NO) VALUES ('789', '6666666666');

INSERT INTO TICKET (TICKET_NO, AIRLINE_NAME, PRICE, SEAT_NO, CLASS, D_TIME, A_TIME, DURATION, DESTINATION, SOURCE, PASSPORT_NO, PASSENGER_NAME) VALUES 
('786', 'SpiceJet', 6000, 'A-2', 'First', TO_DATE('20-FEB-2022 04:00 AM','DD-MON-YYYY HH:MI AM'), TO_DATE('20-FEB-2022 08:30 AM','DD-MON-YYYY HH:MI AM'), 5, 'banglore', 'delhi', '123', 'Parth');
INSERT INTO TICKET (TICKET_NO, AIRLINE_NAME, PRICE, SEAT_NO, CLASS, D_TIME, A_TIME, DURATION, DESTINATION, SOURCE, PASSPORT_NO, PASSENGER_NAME) VALUES 
('777', 'Mumbai Airlines', 4000, 'H-42', 'Second', TO_DATE('24-FEB-2022 09:15 AM','DD-MON-YYYY HH:MI AM'), TO_DATE('25-FEB-2022 09:30 AM','DD-MON-YYYY HH:MI AM'), 4, 'goa', 'chandigarh', '456', 'Tushar');



-- =========================
-- PROCEDURES
-- =========================
CREATE OR REPLACE PROCEDURE add_airport(
    n IN VARCHAR2,
    c IN VARCHAR2,
    s IN VARCHAR2
)
AS
BEGIN
    INSERT INTO AIRPORT (AIRPORT_NAME, CITY, STATE) VALUES (n, c, s);
END;
/

CREATE OR REPLACE PROCEDURE add_airline(
    id IN NUMBER,
    name IN VARCHAR2,
    airport IN VARCHAR2
)
AS
BEGIN
    INSERT INTO AIRLINE (AIRLINE_ID, AIRLINE_NAME, AIRPORT_NAME) VALUES (id, name, airport);
END;
/

BEGIN
    add_airport('Dabolim Airport', 'Dabolim', 'Goa');
    add_airline(130, 'Indigo', 'Dabolim Airport');
END;
/


-- =========================
-- FUNCTION
-- =========================
CREATE OR REPLACE FUNCTION no_of_employee(nam6 VARCHAR2) RETURN NUMBER IS
    a NUMBER;
BEGIN
    SELECT COUNT(*) INTO a FROM EMPLOYEE WHERE AIRPORT_NAME = nam6;
    RETURN a;
END;
/

SELECT no_of_employee('Shivaji') AS employee_count FROM dual;

-- =========================
-- TRIGGER
-- =========================
CREATE TABLE AAIRPORT (
    AIRPORT_NAME VARCHAR2(50) PRIMARY KEY,
    CITY VARCHAR2(50),
    STATE VARCHAR2(50)
);

INSERT INTO AAIRPORT VALUES ('mumbai', 'mumbai', 'maharashtra');
INSERT INTO AAIRPORT VALUES ('delhi', 'delhi', 'delhi');
INSERT INTO AAIRPORT VALUES ('pune', 'pune', 'maharashtra');

CREATE OR REPLACE TRIGGER BEFORE_INSERT_AAIRPORT
BEFORE INSERT ON AAIRPORT
FOR EACH ROW
BEGIN
    :NEW.AIRPORT_NAME := TRIM(:NEW.AIRPORT_NAME);
    :NEW.CITY := TRIM(:NEW.CITY);
    :NEW.STATE := TRIM(:NEW.STATE);
END;
/

INSERT INTO AAIRPORT VALUES ('B ', ' B', 'B ');
SELECT * FROM AAIRPORT;
